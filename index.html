<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Soal Massal - SMAN 2 Cikarang Barat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #2563eb; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; }
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; padding: 20px; line-height: 1.5; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        .alert { background: #fffbeb; border-left: 5px solid var(--warning); padding: 15px; margin-bottom: 20px; color: #92400e; font-size: 0.85rem; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        label { font-weight: 700; margin-bottom: 5px; font-size: 0.8rem; color: #475569; text-transform: uppercase; }
        
        select, input, textarea { padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; outline: none; transition: 0.2s; font-size: 0.95rem; }
        select:focus, input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        textarea { width: 100%; min-height: 200px; font-family: 'Courier New', monospace; font-size: 0.85rem; background: #f8fafc; }

        .btn { padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; width: 100%; font-size: 1rem; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; }

        .progress-container { height: 12px; background: #e2e8f0; border-radius: 6px; margin: 20px 0; display: none; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background: var(--success); transition: 0.3s; }
        
        .status-box { padding: 15px; border-radius: 8px; text-align: center; display: none; font-weight: 600; margin-top: 15px; border: 1px solid transparent; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="color:var(--primary); margin-top: 0;"><i class="fas fa-upload"></i> Input Soal Massal</h2>
    
    <div class="alert">
        <strong>PANDUAN PASTE DARI EXCEL:</strong><br>
        1. Blok kolom di Excel dengan urutan: <b>SOAL | OPSI_A | OPSI_B | OPSI_C | OPSI_D | OPSI_E | LINK_GAMBAR</b><br>
        2. Pastikan <b>OPSI_A</b> berisi jawaban yang benar.<br>
        3. Copy data (tanpa header) dan tempelkan pada kotak teks di bawah.
    </div>

    <div class="grid">
        <div class="form-group">
            <label>Nama Guru</label>
            <select id="nama-guru"><option value="">Memuat data guru...</option></select>
        </div>
        <div class="form-group">
            <label>Mata Pelajaran</label>
            <select id="mapel"><option value="">Memuat data mapel...</option></select>
        </div>
        <div class="form-group">
            <label>Kelas</label>
            <select id="kelas">
                <option value="X">Kelas X</option>
                <option value="XI">Kelas XI</option>
                <option value="XII">Kelas XII</option>
            </select>
        </div>
        <div class="form-group">
            <label>Durasi Ujian</label>
            <select id="durasi">
                <option value="60">60 Menit</option>
                <option value="90">90 Menit</option>
                <option value="120">120 Menit</option>
            </select>
        </div>
    </div>

    <div class="grid" style="grid-template-columns: 2fr 1fr;">
        <div class="form-group">
            <label>Token Ujian (ID Unik)</label>
            <input type="text" id="token-ujian" placeholder="Contoh: PAS-MTK-10">
        </div>
        <div class="form-group">
            <label>Password Guru</label>
            <input type="password" id="pwd-input" placeholder="Password Verifikasi">
        </div>
    </div>

    <div class="form-group" style="margin-bottom: 20px;">
        <label>Tempel Data Soal dari Excel</label>
        <textarea id="paste-area" placeholder="Tempel baris soal hasil copy dari Excel di sini..."></textarea>
    </div>

    <button class="btn btn-primary" id="btn-submit" onclick="mulaiUnggah()">
        <i class="fas fa-paper-plane"></i> UNGGAH SEKARANG
    </button>

    <div class="progress-container" id="prog-cont">
        <div class="progress-bar" id="prog-bar"></div>
    </div>
    <div id="status-display" class="status-box"></div>
</div>

<script>
    const WORKER_URL = "https://nocob-proxy.kurikulum-sman2cikarangbarat.workers.dev";
    let dataGuruCached = [];

    // 1. Ambil Data Guru & Mapel saat Halaman Dimuat
    async function init() {
        try {
            const response = await fetch(`${WORKER_URL}/api/data`);
            const data = await response.json();
            dataGuruCached = data.list || data;

            const guruSelect = document.getElementById('nama-guru');
            const mapelSelect = document.getElementById('mapel');

            const listNama = [...new Set(dataGuruCached.map(i => i.nama_guru))].filter(Boolean).sort();
            const listMapel = [...new Set(dataGuruCached.map(i => i.mapel))].filter(Boolean).sort();

            guruSelect.innerHTML = '<option value="">-- Pilih Guru --</option>' + listNama.map(n => `<option value="${n}">${n}</option>`).join('');
            mapelSelect.innerHTML = '<option value="">-- Pilih Mapel --</option>' + listMapel.map(m => `<option value="${m}">${m}</option>`).join('');
        } catch (err) {
            updateStatus("Gagal terkoneksi ke server database.", "danger");
        }
    }

    function updateStatus(msg, type) {
        const box = document.getElementById('status-display');
        box.style.display = 'block';
        box.style.background = type === 'success' ? '#dcfce7' : (type === 'danger' ? '#fee2e2' : '#e0f2fe');
        box.style.color = type === 'success' ? '#166534' : (type === 'danger' ? '#991b1b' : '#0369a1');
        box.style.borderColor = type === 'success' ? '#86efac' : (type === 'danger' ? '#fecaca' : '#bae6fd');
        box.innerHTML = msg;
    }

    // 2. Logika Utama Pengunggahan
    async function mulaiUnggah() {
        const guru = document.getElementById('nama-guru').value;
        const mapel = document.getElementById('mapel').value;
        const kelas = document.getElementById('kelas').value;
        const durasi = document.getElementById('durasi').value;
        const token = document.getElementById('token-ujian').value;
        const pwd = document.getElementById('pwd-input').value;
        const pasteData = document.getElementById('paste-area').value.trim();

        // Validasi
        const profil = dataGuruCached.find(p => p.nama_guru === guru);
        if (!profil || String(profil.pwd) !== String(pwd)) return updateStatus("Password verifikasi salah!", "danger");
        if (!token || !pasteData) return updateStatus("Token dan Data Soal wajib diisi!", "danger");

        const barisArr = pasteData.split("\n").filter(line => line.trim() !== "");
        const btn = document.getElementById('btn-submit');
        const pCont = document.getElementById('prog-cont');
        const pBar = document.getElementById('prog-bar');

        btn.disabled = true;
        pCont.style.display = 'block';
        updateStatus("Memproses jadwal ujian...", "info");

        try {
            // STEP 1: Kirim ke tabel 'ujian'
            const resUjian = await fetch(`${WORKER_URL}/api/ujian`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    nama_guru: guru,
                    mapel: mapel,
                    kelas: kelas,
                    durasi: parseInt(durasi),
                    token: token,
                    jml_soal: barisArr.length
                })
            });

            if (!resUjian.ok) throw new Error("Gagal menyimpan ke tabel Ujian (Mungkin token sudah ada).");

            // STEP 2: Kirim ke tabel 'bank_soal' satu per satu
            let sukses = 0;
            for (let i = 0; i < barisArr.length; i++) {
                const kolom = barisArr[i].split("\t");
                const payloadSoal = {
                    nama_guru: guru,
                    mapel: mapel,
                    kelas: kelas,
                    token: token,
                    nomor_soal: i + 1,
                    soal: kolom[0]?.trim() || "",
                    opsi_a: kolom[1]?.trim() || "",
                    opsi_b: kolom[2]?.trim() || "",
                    opsi_c: kolom[3]?.trim() || "",
                    opsi_d: kolom[4]?.trim() || "",
                    opsi_e: kolom[5]?.trim() || "",
                    img_link: kolom[6]?.trim() || ""
                };

                updateStatus(`Mengunggah soal ${i + 1} dari ${barisArr.length}...`, "info");
                
                const resSoal = await fetch(`${WORKER_URL}/api/bank_soal`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payloadSoal)
                });

                if (resSoal.ok) {
                    sukses++;
                    pBar.style.width = `${((i + 1) / barisArr.length) * 100}%`;
                }
            }

            if (sukses === barisArr.length) {
                updateStatus(`SUKSES! Semua data (${sukses} soal) berhasil disimpan.`, "success");
                setTimeout(() => location.reload(), 3000);
            } else {
                updateStatus(`Selesai, namun hanya ${sukses} soal yang berhasil masuk.`, "danger");
                btn.disabled = false;
            }

        } catch (err) {
            updateStatus(err.message, "danger");
            btn.disabled = false;
        }
    }

    window.onload = init;
</script>
</body>
</html>
