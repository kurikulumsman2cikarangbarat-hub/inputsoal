<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Input Soal Ujian</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #667eea; min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        header { background: #667eea; color: white; padding: 25px 30px; text-align: center; }
        h1 { font-size: 28px; margin-bottom: 10px; }
        .subtitle { opacity: 0.9; font-size: 16px; }
        .main-content { display: grid; grid-template-columns: 350px 1fr; min-height: 600px; }
        .form-section { padding: 30px; background: #f8f9fa; border-right: 1px solid #e9ecef; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #495057; font-size: 14px; }
        select, input { width: 100%; padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px; background: white; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: #667eea; color: white; margin-top: 10px; }
        .btn-secondary { background: #6c757d; color: white; margin-top: 10px; }
        .editor-section { padding: 30px; display: flex; flex-direction: column; }
        textarea { flex: 1; width: 100%; padding: 20px; border: 2px solid #e9ecef; border-radius: 8px; font-family: 'Consolas', monospace; font-size: 14px; resize: none; }
        .soal-count { background: #667eea; color: white; padding: 5px 12px; border-radius: 20px; font-size: 13px; }
        .status-message { margin-top: 20px; padding: 15px; border-radius: 8px; display: none; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .password-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 3000; justify-content: center; align-items: center; }
        .password-content { background: white; padding: 30px; border-radius: 15px; max-width: 400px; width: 90%; text-align: center; }
        .footer { text-align: center; padding: 15px; color: white; font-size: 12px; }
        @media (max-width: 768px) { .main-content { grid-template-columns: 1fr; } .form-section { border-right: none; border-bottom: 1px solid #e9ecef; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìù Aplikasi Input Soal Ujian</h1>
            <p class="subtitle">SMAN 2 Cikarang Barat</p>
        </header>
        
        <div class="main-content">
            <div class="form-section">
                <div class="form-group">
                    <label>üë®‚Äçüè´ Nama Guru</label>
                    <select id="nama-guru" required>
                        <option value="">Memuat data guru...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>üìö Mata Pelajaran</label>
                    <select id="mapel" required>
                        <option value="">Pilih Mata Pelajaran</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>üè´ Kelas</label>
                    <select id="kelas" required>
                        <option value="">Pilih Kelas</option>
                        <option value="X">X</option>
                        <option value="XI">XI</option>
                        <option value="XII">XII</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>‚è±Ô∏è Durasi Ujian (menit)</label>
                    <select id="durasi" required>
                        <option value="">Pilih Durasi</option>
                        <option value="30">30 Menit</option>
                        <option value="60">60 Menit</option>
                        <option value="90">90 Menit</option>
                        <option value="120">120 Menit</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>üîë Token Ujian</label>
                    <input type="text" id="token" placeholder="Masukkan token ujian" required>
                </div>
                
                <button class="btn btn-primary" onclick="previewData()">üëÅÔ∏è Preview Data</button>
                <button class="btn btn-secondary" onclick="resetForm()">üîÑ Reset Form</button>
            </div>
            
            <div class="editor-section">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <div>
                        <h3>üìù Input Soal (Format TAB)</h3>
                        <p style="color: #666; font-size: 14px;">Paste dari Excel/Spreadsheet</p>
                    </div>
                    <div class="soal-count" id="soal-count">0 soal</div>
                </div>
                
                <textarea id="soal-input" placeholder="Contoh:
Siapa penemu teori relativitas? [TAB] Albert Einstein [TAB] Isaac Newton [TAB] Galileo Galilei [TAB] Nikola Tesla [TAB] Thomas Edison [TAB] https://example.com/einstein.jpg

Hukum Newton pertama disebut... [TAB] Hukum Inersia [TAB] Hukum Aksi-Reaksi [TAB] Hukum Gravitasi [TAB] Hukum Pascal [TAB] Hukum Archimedes [TAB]"></textarea>
                
                <div class="status-message" id="status-message"></div>
                
                <button class="btn btn-primary" onclick="initiateSave()" style="margin-top: 20px;">üíæ Simpan ke Database</button>
            </div>
        </div>
    </div>
    
    <div class="password-overlay" id="password-overlay">
        <div class="password-content">
            <h3>üîê Verifikasi Password</h3>
            <p>Masukkan password untuk konfirmasi:</p>
            <input type="password" id="verification-password" style="width:100%; padding:10px; margin:10px 0; border:1px solid #ccc; border-radius:5px;">
            <div id="password-error" style="color:red; display:none;">Password salah</div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-secondary" onclick="closePasswordOverlay()" style="flex:1;">Batal</button>
                <button class="btn btn-primary" onclick="verifyAndSave()" style="flex:1;">‚úÖ Verifikasi</button>
            </div>
        </div>
    </div>
    
    <div class="footer">
        Dibuat oleh Donny Nugroho ‚Ä¢ SMAN 2 Cikarang Barat
    </div>
    
    <script>
        // Konfigurasi sederhana
        const WORKER_URL = "https://nocob-proxy.kurikulum-sman2cikarangbarat.workers.dev";
        let guruList = [];
        let pendingSaveData = null;

        // Fungsi sederhana untuk show message
        function showMessage(message, type = 'success') {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
            statusDiv.style.display = 'block';
            setTimeout(() => statusDiv.style.display = 'none', 3000);
        }

        // Fungsi untuk memuat data guru
        async function loadGuruData() {
            try {
                showMessage('Memuat data...', 'loading');
                
                const response = await fetch(`${WORKER_URL}/api/data`);
                if (!response.ok) throw new Error('Gagal memuat data');
                
                const data = await response.json();
                
                // Cek struktur data
                console.log('Data dari API:', data);
                
                // Handle response structure
                let dataArray = data.list || data || [];
                
                // Update dropdown guru
                const guruSelect = document.getElementById('nama-guru');
                guruSelect.innerHTML = '<option value="">Pilih Nama Guru</option>';
                
                // Update dropdown mapel
                const mapelSelect = document.getElementById('mapel');
                mapelSelect.innerHTML = '<option value="">Pilih Mata Pelajaran</option>';
                
                // Kumpulkan data unik
                const guruSet = new Set();
                const mapelSet = new Set();
                
                dataArray.forEach(item => {
                    // Ambil nama guru
                    if (item.nama_guru) {
                        guruSet.add(item.nama_guru);
                    }
                    
                    // Ambil mapel
                    if (item.mapel) {
                        mapelSet.add(item.mapel);
                    }
                    
                    // Simpan data lengkap
                    guruList.push(item);
                });
                
                // Isi dropdown guru
                Array.from(guruSet).sort().forEach(nama => {
                    const option = document.createElement('option');
                    option.value = nama;
                    option.textContent = nama;
                    guruSelect.appendChild(option);
                });
                
                // Isi dropdown mapel
                Array.from(mapelSet).sort().forEach(mapel => {
                    const option = document.createElement('option');
                    option.value = mapel;
                    option.textContent = mapel;
                    mapelSelect.appendChild(option);
                });
                
                showMessage('Data berhasil dimuat', 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showMessage('Gagal memuat data', 'error');
            }
        }

        // Fungsi untuk memproses input soal
        function parseSoalInput() {
            const textarea = document.getElementById('soal-input');
            const lines = textarea.value.trim().split('\n');
            
            const soalList = [];
            
            lines.forEach((line, index) => {
                if (line.trim()) {
                    const parts = line.split('\t');
                    if (parts.length >= 6) {
                        const soal = {
                            soal: parts[0]?.trim() || '',
                            opsi_a: parts[1]?.trim() || '',
                            opsi_b: parts[2]?.trim() || '',
                            opsi_c: parts[3]?.trim() || '',
                            opsi_d: parts[4]?.trim() || '',
                            opsi_e: parts[5]?.trim() || '',
                            img_link: parts[6]?.trim() || ''
                        };
                        soalList.push(soal);
                    }
                }
            });
            
            // Update soal count
            document.getElementById('soal-count').textContent = `${soalList.length} soal`;
            
            return soalList;
        }

        // Fungsi untuk preview data
        function previewData() {
            // Validasi form
            const namaGuru = document.getElementById('nama-guru').value;
            const mapel = document.getElementById('mapel').value;
            const kelas = document.getElementById('kelas').value;
            const durasi = document.getElementById('durasi').value;
            const token = document.getElementById('token').value;
            
            if (!namaGuru || !mapel || !kelas || !durasi || !token) {
                showMessage('Harap isi semua field', 'error');
                return;
            }
            
            const soalList = parseSoalInput();
            
            if (soalList.length === 0) {
                showMessage('Tidak ada soal yang ditemukan', 'error');
                return;
            }
            
            alert(`Preview:\nGuru: ${namaGuru}\nMapel: ${mapel}\nKelas: ${kelas}\nDurasi: ${durasi}\nToken: ${token}\nJumlah Soal: ${soalList.length}`);
        }

        // Fungsi untuk menampilkan password overlay
        function showPasswordOverlay() {
            document.getElementById('password-overlay').style.display = 'flex';
            document.getElementById('verification-password').focus();
        }

        // Fungsi untuk menutup password overlay
        function closePasswordOverlay() {
            document.getElementById('password-overlay').style.display = 'none';
            pendingSaveData = null;
        }

        // Fungsi untuk verifikasi password
        function verifyAndSave() {
            const password = document.getElementById('verification-password').value;
            const errorDiv = document.getElementById('password-error');
            
            if (!password) {
                errorDiv.textContent = 'Password harus diisi';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Cari data guru yang sesuai
            const namaGuru = document.getElementById('nama-guru').value;
            const selectedGuru = guruList.find(guru => guru.nama_guru === namaGuru);
            
            if (!selectedGuru) {
                errorDiv.textContent = 'Data guru tidak ditemukan';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Cek apakah ada kolom pwd
            if (!selectedGuru.pwd) {
                errorDiv.textContent = 'Password tidak dikonfigurasi untuk guru ini';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Verifikasi password
            if (selectedGuru.pwd !== password) {
                errorDiv.textContent = 'Password salah';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Password benar, lanjutkan save
            closePasswordOverlay();
            submitData(pendingSaveData);
        }

        // Fungsi untuk memulai proses save
        function initiateSave() {
            // Validasi form
            const namaGuru = document.getElementById('nama-guru').value;
            const mapel = document.getElementById('mapel').value;
            const kelas = document.getElementById('kelas').value;
            const durasi = document.getElementById('durasi').value;
            const token = document.getElementById('token').value;
            
            if (!namaGuru || !mapel || !kelas || !durasi || !token) {
                showMessage('Harap isi semua field', 'error');
                return;
            }
            
            const soalList = parseSoalInput();
            
            if (soalList.length === 0) {
                showMessage('Tidak ada soal yang ditemukan', 'error');
                return;
            }
            
            // Simpan data untuk proses save
            pendingSaveData = {
                namaGuru,
                mapel,
                kelas,
                durasi,
                token,
                soalList
            };
            
            // Tampilkan password overlay
            showPasswordOverlay();
        }

        // Fungsi utama untuk submit data
        async function submitData(data) {
            const { namaGuru, mapel, kelas, durasi, token, soalList } = data;
            
            // Nonaktifkan tombol
            const submitBtn = document.querySelector('.btn-primary');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Mengunggah...';
            
            try {
                showMessage('Menyimpan data ujian...', 'loading');
                
                // 1. Simpan data ujian
                const ujianData = {
                    nama_guru: namaGuru,
                    mapel: mapel,
                    kelas: kelas,
                    durasi: parseInt(durasi),
                    token: token,
                    jml_soal: soalList.length
                };
                
                console.log('Data ujian:', ujianData);
                
                const ujianResponse = await fetch(`${WORKER_URL}/api/ujian`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(ujianData)
                });
                
                if (!ujianResponse.ok) {
                    throw new Error('Gagal menyimpan data ujian');
                }
                
                const ujianResult = await ujianResponse.json();
                console.log('Response ujian:', ujianResult);
                
                showMessage('Menyimpan soal...', 'loading');
                
                // 2. Simpan setiap soal
                let successCount = 0;
                
                for (let i = 0; i < soalList.length; i++) {
                    const soal = soalList[i];
                    const soalData = {
                        ...soal,
                        nama_guru: namaGuru,
                        mapel: mapel,
                        kelas: kelas,
                        token: token,
                        nomor_soal: i + 1
                    };
                    
                    console.log('Data soal:', soalData);
                    
                    const soalResponse = await fetch(`${WORKER_URL}/api/bank_soal`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(soalData)
                    });
                    
                    if (soalResponse.ok) {
                        successCount++;
                        const result = await soalResponse.json();
                        console.log('Response soal:', result);
                    }
                    
                    // Delay kecil
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                
                // 3. Tampilkan hasil
                showMessage(`‚úÖ Berhasil! ${successCount} soal tersimpan`, 'success');
                
                // Reset form jika berhasil
                if (successCount === soalList.length) {
                    resetForm();
                }
                
            } catch (error) {
                console.error('Error:', error);
                showMessage(`‚ùå Gagal: ${error.message}`, 'error');
            } finally {
                // Aktifkan kembali tombol
                submitBtn.disabled = false;
                submitBtn.textContent = 'üíæ Simpan ke Database';
            }
        }

        // Fungsi untuk reset form
        function resetForm() {
            document.getElementById('kelas').value = '';
            document.getElementById('durasi').value = '';
            document.getElementById('token').value = '';
            document.getElementById('soal-input').value = '';
            document.getElementById('soal-count').textContent = '0 soal';
        }

        // Event listener untuk textarea
        document.getElementById('soal-input').addEventListener('input', parseSoalInput);

        // Load data saat halaman dimuat
        document.addEventListener('DOMContentLoaded', loadGuruData);
    </script>
</body>
</html>
