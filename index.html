<script>
    const WORKER_URL = "https://nocob-proxy.kurikulum-sman2cikarangbarat.workers.dev";
    let guruList = []; // Database lokal hasil fetch
    let pendingSaveData = null;

    // 1. Fungsi Load Data (Diperbaiki: Memisahkan Guru dan Mapel)
    async function loadGuruData() {
        try {
            const guruSelect = document.getElementById('nama-guru');
            const mapelSelect = document.getElementById('mapel');
            
            guruSelect.innerHTML = '<option value="">Memuat...</option>';
            mapelSelect.innerHTML = '<option value="">Memuat...</option>';

            const response = await fetch(`${WORKER_URL}/api/data`);
            if (!response.ok) throw new Error('Koneksi API Gagal');
            
            const data = await response.json();
            // Menangani berbagai kemungkinan struktur JSON (array langsung atau objek .list)
            guruList = Array.isArray(data) ? data : (data.list || data.data || []);

            if (guruList.length === 0) {
                throw new Error('Data kosong di database');
            }

            // --- PROSES NAMA GURU (Independen) ---
            const daftarGuru = [...new Set(guruList.map(item => item.nama_guru))]
                                .filter(n => n) // Hapus nilai null/empty
                                .sort();
            
            guruSelect.innerHTML = '<option value="">Pilih Nama Guru</option>';
            daftarGuru.forEach(nama => {
                const opt = document.createElement('option');
                opt.value = nama;
                opt.textContent = nama;
                guruSelect.appendChild(opt);
            });

            // --- PROSES MAPEL (Independen - Tidak melihat nama guru) ---
            const daftarMapel = [...new Set(guruList.map(item => item.mapel))]
                                 .filter(m => m)
                                 .sort();
            
            mapelSelect.innerHTML = '<option value="">Pilih Mata Pelajaran</option>';
            daftarMapel.forEach(mapel => {
                const opt = document.createElement('option');
                opt.value = mapel;
                opt.textContent = mapel;
                mapelSelect.appendChild(opt);
            });

            console.log("Data berhasil dipetakan:", { guru: daftarGuru.length, mapel: daftarMapel.length });
            
        } catch (error) {
            console.error('Error Load:', error);
            document.getElementById('nama-guru').innerHTML = '<option value="">Gagal muat</option>';
            document.getElementById('mapel').innerHTML = '<option value="">Gagal muat</option>';
            alert("Gagal mengambil data dari Worker: " + error.message);
        }
    }

    // 2. Fungsi Verifikasi Password (Diperbaiki)
    function verifyAndSave() {
        const inputPwd = document.getElementById('verification-password').value;
        const selectedGuruName = pendingSaveData.namaGuru;
        
        // Cari data guru untuk mencocokkan password
        const dataGuru = guruList.find(g => g.nama_guru === selectedGuruName);

        if (!dataGuru) {
            alert("Data profil guru tidak ditemukan!");
            return;
        }

        // Konversi ke string untuk menghindari error jika password di excel hanya angka
        if (String(dataGuru.pwd) === String(inputPwd)) {
            closePasswordOverlay();
            submitData(pendingSaveData);
        } else {
            const errDiv = document.getElementById('password-error');
            errDiv.style.display = 'block';
            errDiv.textContent = "Password salah untuk guru: " + selectedGuruName;
        }
    }

    // 3. Sisanya tetap menggunakan fungsi initiateSave dan submitData sebelumnya
    // Namun pastikan fungsi loadGuruData dipanggil saat window load
    window.onload = loadGuruData;
</script>
