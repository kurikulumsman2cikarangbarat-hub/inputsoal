<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Soal v4 - SMAN 2 Cikarang Barat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #2563eb; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; }
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        
        .alert-info { background: #fffbeb; border-left: 5px solid var(--warning); padding: 15px; margin-bottom: 20px; color: #92400e; font-size: 0.9rem; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        label { font-weight: 600; margin-bottom: 5px; font-size: 0.8rem; color: #475569; }
        select, input, textarea { padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 0.9rem; }
        
        textarea { width: 100%; resize: vertical; min-height: 150px; font-family: monospace; font-size: 0.8rem; background: #fafafa; }
        
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: white; margin-top: 10px; }
        .btn-primary:disabled { background: #94a3b8; }

        .progress-bar { height: 10px; background: #e2e8f0; border-radius: 5px; margin: 20px 0; display: none; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: var(--success); transition: 0.3s; }
        
        .status-msg { padding: 12px; border-radius: 8px; text-align: center; display: none; font-weight: 600; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="color:var(--primary); margin-bottom:20px;"><i class="fas fa-upload"></i> Input Soal Massal</h2>

    <div class="alert-info">
        <strong><i class="fas fa-info-circle"></i> Aturan Paste:</strong><br>
        Gunakan urutan TAB: <b>SOAL [TAB] OPSI_A [TAB] OPSI_B [TAB] OPSI_C [TAB] OPSI_D [TAB] OPSI_E [TAB] IMG_LINK</b><br>
        * OPSI_A wajib jawaban benar. Jika tidak ada gambar, kosongkan kolom terakhir.
    </div>

    <div class="grid">
        <div class="form-group">
            <label>Nama Guru</label>
            <select id="nama-guru"><option>Memuat...</option></select>
        </div>
        <div class="form-group">
            <label>Mata Pelajaran</label>
            <select id="mapel"><option>Memuat...</option></select>
        </div>
        <div class="form-group">
            <label>Kelas</label>
            <select id="kelas">
                <option value="X">X</option>
                <option value="XI">XI</option>
                <option value="XII">XII</option>
            </select>
        </div>
        <div class="form-group">
            <label>Durasi</label>
            <select id="durasi">
                <option value="30">30 Menit</option>
                <option value="60">60 Menit</option>
                <option value="90">90 Menit</option>
                <option value="120">120 Menit</option>
            </select>
        </div>
    </div>

    <div class="grid" style="grid-template-columns: 1fr 1fr;">
        <div class="form-group">
            <label>Token Ujian</label>
            <input type="text" id="token-ujian" placeholder="Contoh: BIO10PAS">
        </div>
        <div class="form-group">
            <label>Password Verifikasi</label>
            <input type="password" id="pwd-input" placeholder="Password Anda">
        </div>
    </div>

    <div class="form-group">
        <label>Paste Data Soal (Dari Excel)</label>
        <textarea id="paste-area" placeholder="Tempel soal di sini..."></textarea>
    </div>

    <button class="btn btn-primary" id="btn-submit" onclick="prosesData()">
        <i class="fas fa-paper-plane"></i> Kirim ke Database
    </button>

    <div class="progress-bar" id="prog-bar"><div class="progress-fill" id="prog-fill"></div></div>
    <div id="status-msg" class="status-msg"></div>
</div>

<script>
    const WORKER_URL = "https://nocob-proxy.kurikulum-sman2cikarangbarat.workers.dev";
    let dataGuruGlobal = [];

    // 1. Ambil Data Referensi
    async function loadData() {
        try {
            const res = await fetch(`${WORKER_URL}/api/data`);
            const json = await res.json();
            dataGuruGlobal = json.list || json;
            
            const listGuru = [...new Set(dataGuruGlobal.map(i => i.nama_guru))].filter(Boolean).sort();
            const listMapel = [...new Set(dataGuruGlobal.map(i => i.mapel))].filter(Boolean).sort();

            document.getElementById('nama-guru').innerHTML = '<option value="">Pilih Guru</option>' + listGuru.map(g => `<option value="${g}">${g}</option>`).join('');
            document.getElementById('mapel').innerHTML = '<option value="">Pilih Mapel</option>' + listMapel.map(m => `<option value="${m}">${m}</option>`).join('');
        } catch (e) { showStatus("Gagal memuat data guru/mapel", "danger"); }
    }

    // 2. Tampilkan Status
    function showStatus(msg, type) {
        const box = document.getElementById('status-msg');
        box.style.display = 'block';
        box.style.background = type === 'success' ? '#dcfce7' : '#fee2e2';
        box.style.color = type === 'success' ? '#166534' : '#991b1b';
        box.innerHTML = msg;
    }

    // 3. Proses Pengiriman
    async function prosesData() {
        const guru = document.getElementById('nama-guru').value;
        const mapel = document.getElementById('mapel').value;
        const kelas = document.getElementById('kelas').value;
        const durasi = document.getElementById('durasi').value;
        const token = document.getElementById('token-ujian').value;
        const pwd = document.getElementById('pwd-input').value;
        const rawText = document.getElementById('paste-area').value.trim();

        // Validasi Password
        const user = dataGuruGlobal.find(g => g.nama_guru === guru);
        if(!user || String(user.pwd) !== String(pwd)) return showStatus("Password salah!", "danger");

        if(!rawText) return showStatus("Data soal masih kosong!", "danger");

        // Parsing Data TAB
        const rows = rawText.split("\n");
        const bankSoal = rows.map((line, index) => {
            const cols = line.split("\t");
            return {
                nama_guru: guru,
                mapel: mapel,
                kelas: kelas,
                token: token,
                nomor_soal: index + 1,
                soal: cols[0] || "",
                opsi_a: cols[1] || "",
                opsi_b: cols[2] || "",
                opsi_c: cols[3] || "",
                opsi_d: cols[4] || "",
                opsi_e: cols[5] || "",
                img_link: cols[6] || ""
            };
        });

        const btn = document.getElementById('btn-submit');
        const prog = document.getElementById('prog-bar');
        const fill = document.getElementById('prog-fill');

        btn.disabled = true;
        prog.style.display = 'block';
        fill.style.width = '20%';

        try {
            // STEP 1: Input ke Tabel Ujian
            showStatus("Mencatat header ujian...", "success");
            const resUjian = await fetch(`${WORKER_URL}/api/ujian`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    nama_guru: guru,
                    mapel: mapel,
                    kelas: kelas,
                    durasi: parseInt(durasi),
                    token: token,
                    jml_soal: bankSoal.length
                })
            });

            if(!resUjian.ok) throw new Error("Gagal input ke tabel 'ujian'");
            fill.style.width = '50%';

            // STEP 2: Input ke Tabel Bank Soal
            showStatus(`Mengirim ${bankSoal.length} soal ke bank_soal...`, "success");
            const resSoal = await fetch(`${WORKER_URL}/api/bank_soal`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(bankSoal)
            });

            if(resSoal.ok) {
                fill.style.width = '100%';
                showStatus("BERHASIL! Data ujian dan soal telah masuk.", "success");
                setTimeout(() => location.reload(), 3000);
            } else {
                const errorData = await resSoal.text();
                console.error("NocoDB Error:", errorData);
                throw new Error("Tabel 'bank_soal' menolak data. Periksa nama kolom!");
            }

        } catch (e) {
            showStatus(e.message, "danger");
            btn.disabled = false;
        }
    }

    window.onload = loadData;
</script>

</body>
</html>
