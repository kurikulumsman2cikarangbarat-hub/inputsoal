<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Soal v2 - SMAN 2 Cikarang Barat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #2563eb; --success: #10b981; --error: #ef4444; }
        body { font-family: 'Segoe UI', sans-serif; background: #f1f5f9; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        label { font-weight: 600; margin-bottom: 5px; font-size: 0.85rem; color: #475569; }
        select, input, textarea { padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; outline: none; }
        
        /* Input Mode Tabs */
        .mode-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab { padding: 10px 20px; background: #e2e8f0; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .tab.active { background: var(--primary); color: white; }
        .mode-content { display: none; padding: 20px; border: 2px dashed #cbd5e1; border-radius: 12px; }
        .mode-content.active { display: block; }

        /* Progress & Status */
        .status-box { margin-top: 20px; padding: 15px; border-radius: 8px; display: none; }
        .progress-container { height: 12px; background: #e2e8f0; border-radius: 6px; overflow: hidden; margin: 10px 0; display: none; }
        .progress-fill { height: 100%; width: 0%; background: var(--primary); transition: width 0.3s; }
        
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        .btn-upload { background: var(--primary); color: white; width: 100%; margin-top: 15px; }
        .btn-download { background: #64748b; color: white; text-decoration: none; font-size: 0.8rem; display: inline-block; margin-bottom: 10px; }
        
        #log-area { font-family: monospace; font-size: 0.8rem; margin-top: 10px; max-height: 100px; overflow-y: auto; color: #64748b; }
    </style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="color:var(--primary)">Input Soal Ujian</h2>
        <a href="#" onclick="downloadTemplate()" class="btn btn-download"><i class="fas fa-download"></i> Download Template</a>
    </div>

    <div class="grid">
        <div class="form-group">
            <label>Nama Guru</label>
            <select id="nama-guru"><option>Memuat...</option></select>
        </div>
        <div class="form-group">
            <label>Mata Pelajaran</label>
            <select id="mapel"><option>Memuat...</option></select>
        </div>
        <div class="form-group">
            <label>Token Ujian</label>
            <input type="text" id="token-ujian" placeholder="Contoh: MAT10">
        </div>
        <div class="form-group">
            <label>Password Verifikasi</label>
            <input type="password" id="pwd-input" placeholder="Password Guru">
        </div>
    </div>

    <div class="mode-tabs">
        <div class="tab active" onclick="switchMode('excel')">Upload Excel</div>
        <div class="tab" onclick="switchMode('paste')">Paste Data (JSON/TSV)</div>
    </div>

    <div id="mode-excel" class="mode-content active">
        <input type="file" id="file-excel" accept=".xlsx" onchange="handleExcel(this)">
        <p style="font-size:0.8rem; color:#64748b; margin-top:10px;">Pilih file .xlsx yang sudah diisi sesuai template.</p>
    </div>

    <div id="mode-paste" class="mode-content">
        <textarea id="paste-area" rows="8" style="width:100%" placeholder="Paste data dari Excel (Copy kolomnya saja lalu paste di sini)..."></textarea>
    </div>

    <button class="btn btn-upload" id="btn-submit" onclick="startProcess()">
        <i class="fas fa-paper-plane"></i> Proses Unggah Data
    </button>

    <div class="progress-container" id="prog-container">
        <div class="progress-fill" id="prog-fill"></div>
    </div>
    <div id="status-msg" class="status-box"></div>
    <div id="log-area"></div>
</div>

<script>
    const WORKER_URL = "https://nocob-proxy.kurikulum-sman2cikarangbarat.workers.dev";
    let databaseGuru = [];
    let readyData = [];

    // --- INITIAL LOAD ---
    async function loadData() {
        try {
            const res = await fetch(`${WORKER_URL}/api/data`);
            databaseGuru = await res.json();
            const list = databaseGuru.list || databaseGuru;
            
            const gSel = document.getElementById('nama-guru');
            const mSel = document.getElementById('mapel');
            
            const gurus = [...new Set(list.map(i => i.nama_guru))].sort();
            const mapels = [...new Set(list.map(i => i.mapel))].sort();

            gSel.innerHTML = '<option value="">Pilih Guru</option>' + gurus.map(g => `<option value="${g}">${g}</option>`).join('');
            mSel.innerHTML = '<option value="">Pilih Mapel</option>' + mapels.map(m => `<option value="${m}">${m}</option>`).join('');
        } catch(e) { showStatus("Gagal ambil data guru", "error"); }
    }

    function switchMode(mode) {
        document.querySelectorAll('.tab, .mode-content').forEach(el => el.classList.remove('active'));
        document.getElementById(`mode-${mode}`).classList.add('active');
        event.target.classList.add('active');
    }

    // --- DATA HANDLING ---
    function handleExcel(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const wb = XLSX.read(e.target.result, {type:'binary'});
            readyData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            showStatus(`${readyData.length} soal terbaca dari Excel`, "success");
        };
        reader.readAsBinaryString(input.files[0]);
    }

    function downloadTemplate() {
        const header = [["nomor_soal", "soal", "opsi_a", "opsi_b", "opsi_c", "opsi_d", "opsi_e", "kunci_jawaban"]];
        const ws = XLSX.utils.aoa_to_sheet(header);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "TemplateSoal");
        XLSX.writeFile(wb, "Template_Soal_SMAN2.xlsx");
    }

    // --- UPLOAD PROCESS ---
    async function startProcess() {
        const guru = document.getElementById('nama-guru').value;
        const pwd = document.getElementById('pwd-input').value;
        const token = document.getElementById('token-ujian').value;
        
        // Verifikasi Password
        const user = (databaseGuru.list || databaseGuru).find(g => g.nama_guru === guru);
        if(!user || String(user.pwd) !== String(pwd)) {
            return showStatus("Password salah atau guru belum dipilih!", "error");
        }

        // Ambil data jika mode paste
        if(document.getElementById('mode-paste').classList.contains('active')) {
            const text = document.getElementById('paste-area').value;
            // Logika sederhana konversi TSV (Excel Paste) ke JSON
            const rows = text.split("\n").map(r => r.split("\t"));
            const headers = ["nomor_soal", "soal", "opsi_a", "opsi_b", "opsi_c", "opsi_d", "opsi_e", "kunci_jawaban"];
            readyData = rows.filter(r => r.length > 1).map(row => {
                let obj = {};
                headers.forEach((h, i) => obj[h] = row[i]);
                return obj;
            });
        }

        if(readyData.length === 0) return showStatus("Data soal kosong!", "error");

        const btn = document.getElementById('btn-submit');
        btn.disabled = true;
        document.getElementById('prog-container').style.display = 'block';
        showStatus("Memulai pengunggahan...", "success");

        try {
            // 1. Upload Header Ujian
            const resUjian = await fetch(`${WORKER_URL}/api/ujian`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    nama_guru: guru,
                    mapel: document.getElementById('mapel').value,
                    token: token,
                    jml_soal: readyData.length
                })
            });

            // 2. Upload Bank Soal (Chunked / Bertahap agar tidak timeout)
            const logArea = document.getElementById('log-area');
            const total = readyData.length;
            
            // Tambahkan metadata ke setiap soal
            const finalSoal = readyData.map(s => ({
                ...s,
                token: token,
                nama_guru: guru
            }));

            // Kirim data ke NocoDB (NocoDB POST API menerima Array untuk Bulk Insert)
            const resSoal = await fetch(`${WORKER_URL}/api/bank_soal`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(finalSoal) 
            });

            if(resSoal.ok) {
                document.getElementById('prog-fill').style.width = '100%';
                showStatus("Selesai! Semua data berhasil masuk ke database.", "success");
                setTimeout(() => location.reload(), 3000);
            } else {
                throw new Error("Gagal kirim ke bank_soal");
            }

        } catch(e) {
            showStatus("Error: " + e.message, "error");
            btn.disabled = false;
        }
    }

    function showStatus(msg, type) {
        const box = document.getElementById('status-msg');
        box.style.display = 'block';
        box.style.background = type === 'success' ? '#dcfce7' : '#fee2e2';
        box.style.color = type === 'success' ? '#166534' : '#991b1b';
        box.textContent = msg;
    }

    window.onload = loadData;
</script>
</body>
</html>
